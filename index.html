<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KPI Salary Calculator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      font-size: 14px; 
      background-color: #f5f5f5;
    }
    .controls { 
      margin-bottom: 20px; 
      display: flex; 
      align-items: center; 
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    label { 
      margin-right: 10px; 
      white-space: nowrap; 
      font-weight: bold;
      color: #555;
    }
    select, input[type="month"] { 
      margin-right: 15px; 
      padding: 5px; 
      font-size: 14px; 
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    #status { 
      margin-top: 10px; 
      color: #333; 
      padding: 8px;
      background: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .loading { color: #666; font-style: italic; }
    .error { color: #d32f2f; }
    .warning { color: #ed6c02; }

    .jqgrid-style {
      border: 1px solid #ccc;
      background-color: white;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .jqgrid-style table {
      min-width: 1700px;
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 0;
    }
    .jqgrid-style th {
      background: linear-gradient(to bottom, #f8f8f8 0%, #e5e5e5 100%);
      border: 1px solid #ccc;
      border-bottom: 2px solid #aaa;
      color: #333;
      font-weight: bold;
      padding: 8px 6px;
      text-align: center;
      text-shadow: 0 1px 0 rgba(236, 247, 255, 0.5);
    }
    .jqgrid-style td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
      word-wrap: break-word;
      background-color: white;
    }
    .jqgrid-style tr:nth-child(even) td {
      background-color: #f9f9f9;
    }
    .jqgrid-style tr:hover td {
      background-color: #e6f3ff !important;
    }
    .jqgrid-style tfoot td {
      background: linear-gradient(to bottom, #f8f8f8 0%, #e5e5e5 100%);
      font-weight: bold;
      border-top: 2px solid #aaa;
      border-bottom: 1px solid #ccc;
    }

    .highlight { background-color: #fffde7 !important; }
    .good { color: #2e7d32; font-weight: bold; }
    .bad { color: #c62828; font-weight: bold; }
    .program-header { background-color: #e1f5fe !important; }
    .jqgrid-style thead tr:first-child th {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .jqgrid-style table {
      border-radius: 4px;
      overflow: hidden;
    }

    .table-container {
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h1 style="margin-bottom: 20px; color: #333;">KPI Salary Calculator</h1>

    <div class="controls" id="filterControls">
      <label>Месяц:
        <input type="month" id="selectedMonth" value="2025-05">
      </label>
    </div>

    <div id="status" class="loading">Загрузка данных...</div>

    <div class="table-container">
      <div class="jqgrid-style">
        <div class="table-responsive">
          <table id="resultTable" style="display: none;">
            <thead>
              <tr>
                <th>Имя</th>
                <th>Категория</th>
                <th class="program-header">Начало</th>
                <th class="program-header">Конец</th>
                <th class="program-header">Визиты (факт)</th> 
                <th class="program-header">Занятия</th>
                
                <th>Абонементы (план)</th>
                <th>Абонементы (факт)</th>
                <th>Абонементы (%)</th>
                
                <th>Посещаемость (план)</th> 
                <th>Посещаемость (факт)</th> 
                <th>Посещаемость (%)</th> 
                
                <th>Потери (план)</th>
                <th>Потери (факт)</th>
                <th>Потери (%)</th>
                
                <th>Новички (факт)</th>
                
                <th>Оклад</th>
                <th>Премия (KPI)</th>
                <th>Перс. план (руб)</th>
                <th>Перс. факт (руб)</th>
                <th>Персон. занятия</th>
                <th>Итого</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="2">Итого</td>
                <td id="sumStart" class="program-header">0</td>
                <td id="sumEnd" class="program-header">0</td>
                <td id="sumVisits" class="program-header">0</td> 
                <td id="sumLessons" class="program-header">0</td>
                <td id="sumSubsPlan">0</td>
                <td id="sumSubsFact">0</td>
                <td id="sumSubsPct">0%</td>
                <td id="sumAttendancePlan">0</td> 
                <td id="sumAttendanceFact">0</td> 
                <td id="sumAttendancePct">0%</td> 
                <td id="sumLossPlan">0</td>
                <td id="sumLossFact">0</td>
                <td id="sumLossPct">0%</td>
                <td id="sumNewFact">0</td>
                <td id="sumSalary">0</td>
                <td id="sumBonus">0</td>
                <td id="sumPersPlan">0</td>
                <td id="sumPersFact">0</td>
                <td id="sumPersonal">0</td>
                <td id="sumTotal">0</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let trainersData = [];
    let globalConfig = {};
    let currentDataMonth = '';

    // Основная функция расчета данных за месяц
    function calculateMonthData(monthData) {
      if (!monthData) return null;
      
      const prog = monthData.programm || {};
      const attendance = prog.attendance || {};
      
      // Преобразование строк в числа
      const safeNumber = (value) => Number(value) || 0;
      
      return {
        start: safeNumber(prog.start),
        end: safeNumber(prog.end),
        visits: safeNumber(prog.visits), // Общее количество визитов
        attendancePlan: safeNumber(attendance.plan), // План по посещаемости
        attendanceFact: safeNumber(attendance.fact), // Факт по посещаемости
        lessons: safeNumber(prog.lessons),
        purchased: safeNumber(monthData.purchased),
        newbies: safeNumber(monthData.newbies),
        personalLessons: monthData.personalLessons || {}
      };
    }

    function calcPercent(plan, fact) {
      const p = Number(plan) || 0;
      const f = Number(fact) || 0;
      
      if (p === 0 && f === 0) return 0;
      if (p === 0) return 100;
      
      const pct = Math.floor((f / p) * 100);
      return isFinite(pct) ? pct : 0;
    }

    function calcKPI(payout, plan, fact, minPct = 0, allowZeroSpecial = false) {
      if (plan === 0 && allowZeroSpecial) {
        return fact >= minPct ? payout : 0;
      }
      
      if (plan === 0) return 0;
      
      const pct = (fact / plan) * 100;
      if (pct < minPct) return 0;
      
      return Math.round(payout * Math.min(pct, 100) / 100);
    }

    function calcPersonal(plan, fact) {
      const percentage = fact >= plan ? 0.5 : 0.4;
      return Math.round(fact * percentage);
    }

    function fmt(n) { 
      return Number(n).toLocaleString('ru-RU', {maximumFractionDigits: 0}); 
    }

    function toYearMonth(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      if (isNaN(date)) return '';
      
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      return `${year}-${month}`;
    }

    async function loadData(month) {
      try {
        const url = `https://msgym.scrm123.ru/hook/msgym.salarydata?month=${month}`;
        const res = await fetch(url);
        
        if (!res.ok) {
          throw new Error(`Ошибка сервера: ${res.status} ${res.statusText}`);
        }
        
        const data = await res.json();
        
        // Проверяем, за какой месяц данные
        const dataMonth = toYearMonth(data.d1);
        currentDataMonth = dataMonth;
        
        // Проверяем соответствие запрошенного месяца и данных
        if (dataMonth !== month) {
          document.getElementById('status').className = 'warning';
          document.getElementById('status').textContent = 
            `Внимание: данные за ${month} отсутствуют. Показаны данные за ${dataMonth || 'другой период'}`;
        } else {
          document.getElementById('status').className = '';
          document.getElementById('status').textContent = `Данные за ${month} загружены`;
        }
        
        globalConfig = data.cfg || {};
        
        trainersData = data.rows.map(row => {
          const cfg = row.cfg || globalConfig[row.catmsgym] || {};
          return {
            ...row,
            cfg
          };
        });
        
        updateResult(month);
      } catch(err) {
        console.error('Ошибка загрузки данных:', err);
        document.getElementById('status').className = 'error';
        document.getElementById('status').textContent = `Ошибка: ${err.message}`;
        document.getElementById('resultTable').style.display = 'none';
      }
    }

    function updateResult(month) {
      const tbody = document.querySelector('#resultTable tbody');
      tbody.innerHTML = '';

      let totals = { 
        start: 0, end: 0, 
        visits: 0, lessons: 0, // visits - общее количество визитов
        attendancePlan: 0, attendanceFact: 0, // посещаемость для KPI
        subsPlan: 0, subsFact: 0, 
        lossPlan: 0, lossFact: 0, 
        newFact: 0,
        salary: 0, bonus: 0, 
        persPlan: 0, persFact: 0,
        personal: 0, total: 0 
      };

      trainersData.forEach(tr => {
        const data = calculateMonthData(tr);
        if (!data) return;
        
        const cfg = tr.cfg || {};
        const base = cfg.base || 0;
        const motiv = cfg.motiv || 0;
        
        // Расчет планов
        const subsPlan = Math.round(data.start * 0.95);
        const subsFact = data.purchased;
        
        const attendancePlan = data.attendancePlan;
        const attendanceFact = data.attendanceFact;
        
        const lossPlan = data.start;
        const lossFact = Math.max(0, data.end - data.newbies);
        
        const newFact = data.newbies;
        
        // Данные по персональным тренировкам
        const persPlan = data.personalLessons?.plan || 0;
        const persFact = data.personalLessons?.fact || 0;
        const pers = calcPersonal(persPlan, persFact);
        
        // Расчет KPI
        const kVis = attendancePlan > 0 ? calcKPI(motiv * 0.3, attendancePlan, attendanceFact, 0) : 0;
        const kSub = subsPlan > 0 ? calcKPI(motiv * 0.2, subsPlan, subsFact, 0) : 0;
        const kLoss = lossPlan > 0 ? calcKPI(motiv * 0.3, lossPlan, lossFact, 91) : 0;
        const kNew = calcKPI(motiv * 0.1, 0, newFact, 51, true);
        
        // Общая премия
        const bonus = kVis + kSub + kLoss + kNew;
        const total = base + bonus + pers;

        totals.start += data.start;
        totals.end += data.end;
        totals.visits += data.visits; // Общее количество визитов
        totals.lessons += data.lessons;
        totals.attendancePlan += attendancePlan; // План по посещаемости
        totals.attendanceFact += attendanceFact; // Факт по посещаемости
        totals.subsPlan += subsPlan;
        totals.subsFact += subsFact;
        totals.lossPlan += lossPlan;
        totals.lossFact += lossFact;
        totals.newFact += newFact;
        totals.salary += base;
        totals.bonus += bonus;
        totals.persPlan += persPlan;
        totals.persFact += persFact;
        totals.personal += pers;
        totals.total += total;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${tr.name}</td>
          <td>${tr.catmsgym}</td>
          <td class="program-header">${data.start}</td>
          <td class="program-header">${data.end}</td>
          <td class="program-header">${fmt(data.visits)}</td> <!-- Визиты (факт) -->
          <td class="program-header">${fmt(data.lessons)}</td>
          
          <td>${fmt(subsPlan)}</td>
          <td>${fmt(subsFact)}</td>
          <td class="${getClass(calcPercent(subsPlan, subsFact))}">
            ${calcPercent(subsPlan, subsFact)}%
          </td>
          
          <td>${fmt(attendancePlan)}</td> <!-- Посещаемость (план) -->
          <td>${fmt(attendanceFact)}</td> <!-- Посещаемость (факт) -->
          <td class="${getClass(calcPercent(attendancePlan, attendanceFact))}">
            ${calcPercent(attendancePlan, attendanceFact)}%
          </td>
          
          <td>${fmt(lossPlan)}</td>
          <td>${fmt(lossFact)}</td>
          <td class="${getClass(calcPercent(lossPlan, lossFact))}">
            ${calcPercent(lossPlan, lossFact)}%
          </td>
          
          <td>${fmt(newFact)}</td>
          
          <td>${fmt(base)}</td>
          <td class="${bonus > 0 ? 'good' : 'bad'}">${fmt(bonus)}</td>
          <td>${fmt(persPlan)}</td>
          <td>${fmt(persFact)}</td>
          <td>${fmt(pers)}</td>
          <td class="highlight">${fmt(total)}</td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById('sumStart').textContent = fmt(totals.start);
      document.getElementById('sumEnd').textContent = fmt(totals.end);
      document.getElementById('sumVisits').textContent = fmt(totals.visits); // Визиты (факт)
      document.getElementById('sumLessons').textContent = fmt(totals.lessons);
      document.getElementById('sumSubsPlan').textContent = fmt(totals.subsPlan);
      document.getElementById('sumSubsFact').textContent = fmt(totals.subsFact);
      document.getElementById('sumSubsPct').textContent = `${calcPercent(totals.subsPlan, totals.subsFact)}%`;
      document.getElementById('sumAttendancePlan').textContent = fmt(totals.attendancePlan); // Посещаемость (план)
      document.getElementById('sumAttendanceFact').textContent = fmt(totals.attendanceFact); // Посещаемость (факт)
      document.getElementById('sumAttendancePct').textContent = `${calcPercent(totals.attendancePlan, totals.attendanceFact)}%`;
      document.getElementById('sumLossPlan').textContent = fmt(totals.lossPlan);
      document.getElementById('sumLossFact').textContent = fmt(totals.lossFact);
      document.getElementById('sumLossPct').textContent = `${calcPercent(totals.lossPlan, totals.lossFact)}%`;
      document.getElementById('sumNewFact').textContent = fmt(totals.newFact);
      document.getElementById('sumSalary').textContent = fmt(totals.salary);
      document.getElementById('sumBonus').textContent = fmt(totals.bonus);
      document.getElementById('sumPersPlan').textContent = fmt(totals.persPlan);
      document.getElementById('sumPersFact').textContent = fmt(totals.persFact);
      document.getElementById('sumPersonal').textContent = fmt(totals.personal);
      document.getElementById('sumTotal').textContent = fmt(totals.total);

      document.getElementById('resultTable').style.display = 'table';
    }

    function getClass(pct) {
      if (pct >= 100) return 'good';
      if (pct > 0 && pct < 80) return 'bad';
      return '';
    }
    window.addEventListener('DOMContentLoaded', () => {
      const monthInput = document.getElementById('selectedMonth');
      monthInput.addEventListener('change', () => {
        document.getElementById('status').className = 'loading';
        document.getElementById('status').textContent = 'Загрузка данных...';
        document.getElementById('resultTable').style.display = 'none';
        loadData(monthInput.value);
      });
      loadData(monthInput.value);
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
